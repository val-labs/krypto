<!doctype html>
<html>
  <div>
    <li>whats your seed
      <button onclick=setSeed()>Enter Seed</button>
      <button onclick=dumpSeed()>Dump Seed</button>
      <button onclick=createSeed2()>Create Seed</button>
      <button onclick=usecat("alice")>Alice Cat</button>
      <button onclick=usecat("bob")>Bobcat</button>
      <button onclick=usecat("chuck")>Chuck Cat</button>
    </li>
    <li>whats your private
      <button onclick=dumpPrivate()>Dump Private</button></li>
    <li>whats your public: <span id="publickey">???</span> </li>
    <hr>
    <textarea id="textarea" placeholder="blah . . ."></textarea><br>
    <button onclick=meow()>MEOW</button>
    <button onclick=purr()>PURR</button>
    <button onclick=hiss()>HISS</button>
    <button onclick=xclear()>CLEAR</button>
    <script>
      function sendit(txt){
	  var s0 = xsignit(txt);
	  var msg = s0 + txt;
	  console.log(msg);
	  app.pub("main", msg);
      }
      function meow(){
	  var textarea = GEBI("textarea");
	  var txt = textarea.value;
	  txt = "meow: " + txt;
	  sendit(txt);
      }
      function purr(){
	  var textarea = GEBI("textarea");
	  var txt = textarea.value;
	  txt = "purr: " + txt;
	  sendit(txt);
      }
      function hiss(){
	  var textarea = GEBI("textarea");
	  var txt = textarea.value;
	  txt = "hiss: " + txt;
	  sendit(txt);
      }
      function xclear(){
	  var textarea = GEBI("textarea");
	  textarea.value='';
	  textarea.focus();
      }
      function createSeed2(){
	  console.log(createSeed());
	  setPublic();
      }
      function dumpSeed(){
	  console.log(getSeed());
      }
      function dumpPrivate(){
	  console.log(getPrivate());
      }
      function setSeed(){
	  var inp = prompt("What's your seed? (Hex format)");
	  var r = xsetseed(inp);
	  console.log("r", r);
      }
      function setPrivate(){
	  var inp = prompt("What's your private key? (Hex format)");
	  var r = xsetprivate(inp);
	  console.log("r", r);
      }
      function setPublic(){
	  GEBI("publickey").innerText = getPublic();
      }
    </script>
  </div>
  <div id="out"></div>
  <script>    
    D=document;
    function GEBI(id){
	return D.getElementById(id);}
    function outs(s){
	var tn = D.createTextNode(s);
	var li = D.createElement("li");
	li.appendChild(tn);
	GEBI("out").appendChild(li);
    }
    function testKeys() {
	var m1 = "xyz\n";
	var s0 = xsignit(m1);
	var s9 = xsignitlong(m1);
	outs("it's " + s0);
	var sig = s0;
	outs("2it's " + sig);	  
	var s2 = xverify(sig +m1);
	outs("it's " + s2);
	var s3 = xverify(sig + "wrong");
	outs("it's " + s3);
	var s4 = xverify("no way" + m1);
	outs("it's " + s4);
	outs("Qt's " + s9);
    }
    Cats = {};
    Cats['alice']={seed:"0000000000000000000000000000000000000000000000000000000000000001"};
    Cats['bob'  ]={seed:"0000000000000000000000000000000000000000000000000000000000000002"};
    Cats['chuck']={seed:"0000000000000000000000000000000000000000000000000000000000000003"};
    function usecat(name){
	xsetseed(Cats[name].seed);
	setPublic();
    }
    var Module = {
	onRuntimeInitialized: function() {
	    createSeed  = Module.cwrap('createSeed',  'void',   []);
	    getSeed     = Module.cwrap('getSeed',     'string', []);
	    getPublic   = Module.cwrap('getPublic',   'string', []);
	    getPrivate  = Module.cwrap('getPrivate',  'string', []);
	    xsetseed    = Module.cwrap('xsetseed',    'string', ['string']);
	    xsetprivate = Module.cwrap('xsetprivate', 'string', ['string']);
	    xsignitlong = Module.cwrap('xsignitlong', 'string', ['string']);
	    xsignit     = Module.cwrap('xsignit',     'string', ['string']);
	    xverify     = Module.cwrap('xverify',     'int',    ['string']);
	    xsetseed("0000000000000000000000000000000000000000000000000000000000000000");
	    testKeys();
	    setPublic();
	}
    };
  </script>
  <script>
    function connect(){
	var loc = "wss://ccl.io/ps/";
	var app = new WebSocket(loc);
	app.onopen =function(e){outs("OO");
				app.state=0;app.onconnect(e);};
	app.onclose=function(e){outs("CC");};
	app.onerror=function(e){outs("EE");};
	app.onmessage=function(e){
	    console.log("QQQ1", e.data, "ZZZ");
	    var arr = e.data.split(";", 3);
	    console.log("QQQ2", arr, "ZZZ");
	    e.ttl = arr[0];
	    e.channel = arr[1];
	    e.message = arr[2];
	    if(!app.myid)
		app.myid = arr[1];
	    return app.onpub(e);}
	app.sub = function(chn){    app.send("0;+;"+chn);};
	app.unsub=function(chn){    app.send("0;-;"+chn);};
	app.pub = function(chn,msg){app.send("3;" + chn+";"+msg);};
	app.onconnect=function(e){
	    app.sub("main");
	    app.sub("weird");
	    app.pub("main", "yo world");
	};
	app.onpub=function(e){
	    outs("I:" + app.myid);
	    outs("C:" + e.channel);
	    outs("D:" + e.data);
	    outs("M:" + e.message);
	};
	return app;}
    app = connect();
  </script>
  <script>
    app.onpub=function(e){
	outs("...I:" + app.myid);
	outs("...C:" + e.channel);
	outs("...M:" + e.message);
    };
  </script>
  <script src="test2.js"></script>
</html>
